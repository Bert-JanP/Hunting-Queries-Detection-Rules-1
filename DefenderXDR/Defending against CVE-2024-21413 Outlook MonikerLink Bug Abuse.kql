//Defending against CVE-2024-21413 Outlook MonikerLink Bug Abuse
//https://www.linkedin.com/pulse/defending-against-cve-2024-21413-outlook-monikerlink-bug-steven-lim-wesac/

let VulnerableEndpoints =
DeviceTvmSoftwareVulnerabilities 
| where CveId == "CVE-2024-21413"
| project DeviceId;
DeviceProcessEvents
| where FileName=="OUTLOOK.EXE"
| join DeviceNetworkEvents on DeviceId
| where DeviceId has_any(VulnerableEndpoints)
| where RemotePort == 445
| where RemoteIPType=="Public"
| where ActionType1=="ConnectionSuccess"
| project Timestamp, DeviceName, AccountUpn, ActionType1, RemoteIP


// MITRE ATT&CK Mapping

// Based on the KQL code, the following MITRE ATT&CK techniques are relevant:

// T1071.001 - Application Layer Protocol: Web Protocols:
// The query checks for network connections, which can be associated with the use of application layer protocols.

// T1047 - Windows Management Instrumentation:
// Monitoring OUTLOOK.EXE could be related to the use of legitimate software for malicious purposes.

// T1078 - Valid Accounts:
// The query projects AccountUpn, indicating a focus on user accounts, which could be related to the use of valid accounts for malicious activities.

// T1049 - System Network Connections Discovery:
// The query checks for network connections, which aligns with discovering network connections on the system.

// T1105 - Ingress Tool Transfer:
// The focus on successful connections to public IPs on port 445 could indicate data transfer or tool ingress.
