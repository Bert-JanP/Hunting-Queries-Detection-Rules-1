//DefenderXDR Exposure Management for CVE-2024-3094
//https://www.linkedin.com/posts/activity-7180041278829580288-I4hU/

//After reading so many infosec posts relating XZ, I decided to build this high precision KQL detection using the latest DefenderXDR exposure management capability to determine Azure internet facing Linux machines that has vulnerable compromised XZ and running SSHD which are susceptible to RCE attack. If you have this rule triggered, I would strongly suggest you quickly remediate your Linux VM.ðŸ«¡

let DeviceWithVulnerableXZ =
DeviceTvmSoftwareInventory 
| where SoftwareName contains "xz"
| where SoftwareVersion contains "5.6."
| distinct DeviceName;
let DevicewithSSHD =
DeviceNetworkEvents
| where ActionType == "ListeningConnectionCreated"
| where LocalPort == 22
| distinct DeviceName;
ExposureGraphNodes
| where NodeLabel == 'device' or (Categories has 'virtual_machine' and set_has_element(Categories, 'virtual_machine'))
// Condition: Internet Facing with vulnerable XZ and running SSHD
| where NodeProperties.rawData.isInternetFacing == true
| where NodeName has_any (DeviceWithVulnerableXZ)
| where NodeName has_any (DevicewithSSHD)


// MITRE ATT&CK Mapping

// Based on the KQL code, the following MITRE ATT&CK techniques are relevant:

// T1190 - Exploit Public-Facing Application:
// The query identifies internet-facing devices with vulnerable software, which could be exploited by attackers.

// T1078 - Valid Accounts:
// The presence of SSHD (port 22) suggests potential use of valid accounts for remote access.

// T1046 - Network Service Scanning:
// Identifying devices with specific services running (like SSHD) can be part of network service scanning activities.

// T1210 - Exploitation of Remote Services:
// Exploiting vulnerabilities in remote services (like SSHD) to gain unauthorized access.
